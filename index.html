<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flowdrom</title>
  
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/default.min.css">
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Clean title styles */
    .title-container {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px 0;
      background: linear-gradient(135deg, #2a5eb2 0%, #1a4a8a 100%);
      border-radius: 12px;
    }

    .main-title {
      font-size: 3.5em;
      font-weight: 800;
      margin: 0;
      color: white;
      letter-spacing: 3px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .subtitle {
      font-size: 1.2em;
      color: rgba(255,255,255,0.9);
      margin: 10px 0 0 0;
      font-weight: 300;
      letter-spacing: 2px;
    }

    .tech-accent {
      font-family: 'Courier New', monospace;
      color: #87ceeb;
      font-weight: bold;
    }

    h1 {
      color: #2a5eb2;
      margin-bottom: 20px;
      text-align: center;
    }

    .input-section {
      width: 100%;
      margin-bottom: 20px;
    }

    /* CodeMirror styling */
    .CodeMirror {
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      height: auto;
      min-height: 400px;
    }

    .CodeMirror-scroll {
      min-height: 400px;
    }

    /* Hide the original textarea but keep it for compatibility */
    #input {
      display: none;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 10px 20px;
      background: #2a5eb2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #1a4a8a;
    }

    button.secondary {
      background: #6c757d;
    }

    button.secondary:hover {
      background: #5a6268;
    }

    #svg-container {
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      overflow: auto;
    }

    .lane-label {
      font-weight: bold;
      font-size: 18px;
      text-anchor: middle;
      fill: #2a5eb2;
    }

    .sub-lane-label {
      font-weight: bold;
      font-size: 12px;
      text-anchor: middle;
      fill: #2a5eb2;
    }

    .lane-group-label {
      font-weight: bold;
      font-size: 14px;
      text-anchor: middle;
      fill: #6699cc;
    }

    .lane-group-bracket {
      stroke: #6699cc;
      stroke-width: 2;
      stroke-dasharray: 4,4;
      fill: none;
    }

    .message-label {
      font-size: 15px;
      font-family: 'Courier New', monospace;
      dominant-baseline: middle;
      font-weight: bold; 
    }

    .label-box {
      fill: white;
      stroke: none;
    }

    .state-label {
      font-size: 11px;
      fill: black;
      font-family: sans-serif;
      text-anchor: middle;
    }

    .state-box {
      fill: #ffffcc;
      stroke: #aaa;
      rx: 4;
      ry: 4;
    }

    .arrow {
      stroke-width: 2;
    }

    .dashed {
      stroke-dasharray: 5,5;
    }

    .time-label {
      font-size: 12px;
      fill: #666;
      font-family: sans-serif;
    }

    .grid-line {
      stroke: #eee;
      stroke-width: 1;
    }

    .export-section {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }

    .legend-box {
      fill: white;
      stroke: #ccc;
      stroke-width: 1;
      rx: 6;
      ry: 6;
    }

    .legend-title {
      font-weight: bold;
      font-size: 16px;
      fill: #2a5eb2;
    }

    .legend-label {
      font-size: 27px;
      font-family: 'Courier New', monospace;
      dominant-baseline: middle;
    }

    .info-box {
      fill: white;
      stroke: #333;
      stroke-width: 1;
      rx: 4;
      ry: 4;
    }

    .info-box-text {
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
      fill: #333;
    }

    .info-box-line {
      stroke: #333;
      stroke-width: 1;
      stroke-dasharray: 3,3;
      fill: none;
    }
    
    .docs-link {
      font-size: 18px;
      padding: 10px 10px;
      margin-top: 18px;
      background-color: #1b64ae;
      color: #ffffff;
      border: 2px solid #007acc;
      text-decoration: none;
      border-radius: 6px;
      display: inline-block;
      transition: all 0.3s ease;
    }

    .docs-link:hover {
      background-color: #830352;
      color: #ffffff;
      transform: translateY(2px);
    }

      /* Make autocomplete menu bigger */
    .CodeMirror-hints {
    max-width: 400px !important;     /* Increase width */
    min-width: 300px !important;     /* Set minimum width */
    max-height: 300px !important;    /* Increase height */
    font-size: 14px !important;      /* Larger text */    
    }

    .CodeMirror-hint {
    padding: 8px 12px !important;    /* More padding for bigger items */
    line-height: 1.4 !important;     /* Better line spacing */
    }

    .CodeMirror-hint-active {
    background: #2a5eb2 !important;  /* Match your theme colors */
    color: white !important;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Clean title section -->
    <div class="title-container">
      <h1 class="main-title">FLOWDROM</h1>
      <p class="subtitle">Transaction Sequence <span class="tech-accent">[DIAGRAMS]</span></p>
      <a href="docs/" class="docs-link">ðŸ“– Documentation / User Guide</a>
    </div>
          
    <div class="input-section">
      <label for="input"><strong>Transaction JSON (use "|" for line breaks):</strong></label>
      
      <!-- Hidden textarea for compatibility with existing main.js -->
      <textarea id="input" rows="21">{
  title: 'Conflict: Two CAs ReadUnique Same Address',
  lanes: ['CA0', 'CA1', 'HN'],
  infoBoxes: [{ lane: 'HN', time: 2, text: 'Conflict detected|serialize requests' }],
  messages: [
    { path: 'CA0->HN', label: 'Read|Unique(A)',  color: 'red',    style: 'solid',  fromTime: 0, toTime: 1 },
    { path: 'CA1->HN', label: '<Read|Unique(A)', color: 'red',    style: 'dashed', fromTime: 1, toTime: 2 },
    { path: 'HN->CA1', label: 'SnpInvalid(A)',   color: 'purple', style: 'solid',  fromTime: 1, toTime: 4 },
    { path: 'CA1->HN', label: 'SnpResp(I)',      color: 'green',  style: 'solid',  fromTime: 4, toTime: 6 }
  ],
  states: [
    { lane: 'CA0', label: 'I->UD', color: 'yellow', fromTime: 0, toTime: 0.5 },
    { lane: 'CA1', label: 'S->I',  color: 'orange', fromTime: 4, toTime: 4.5 },
    { lane: 'HN',  label: 'block', color: 'pink', fromTime: 2, toTime: 6 },
  ],
  legend: [
    { label: 'Request',    color: 'red',    style: 'solid' },
    { label: 'Conflicted', color: 'red',    style: 'dashed' },
    { label: 'Snoop',      color: 'purple', style: 'solid' },
    { label: 'Response',   color: 'green',  style: 'solid' },
  ]
}</textarea>

      <!-- CodeMirror editor container -->
      <div id="codemirror-container"></div>

      <div class="button-group">
        <button onclick="renderGraph()">Render</button>
        <button onclick="exportSVG(true)">Export SVG</button>
        <button onclick="exportPNG()">Export PNG</button>
        <input type="file" id="svgFileInput" accept=".svg" style="display: none;" onchange="loadSVGFile(event)">
        <button onclick="document.getElementById('svgFileInput').click()">Load SVG</button>
      </div>
    </div>

    <h1 id="graph-title" style="display: none;">Enhanced Transaction Sequence Graph</h1>
    <div id="svg-container"></div>
  </div>

  <!-- CodeMirror Core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  
  <!-- CodeMirror JavaScript Mode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  
  <!-- CodeMirror Addons for dynamic features -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  
  <!-- CodeMirror Hint CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
  
  <script src="src/js/json5.min.js"></script>
  
  <!-- Simple Snippet Autocomplete -->
  <script>
    // Simple snippet-based autocomplete
    CodeMirror.registerHelper("hint", "snippets", function(editor, options) {
      const cur = editor.getCursor();
      const curLine = editor.getLine(cur.line);
      let start = cur.ch, end = cur.ch;
      
      // Find word boundaries
      while (start && /\w/.test(curLine.charAt(start - 1))) --start;
      while (end < curLine.length && /\w/.test(curLine.charAt(end))) ++end;
      
      const word = curLine.slice(start, end).toLowerCase();
      
      // Define simple snippets
      const snippets = {
        'legend': `legend: [
    { label: 'Request', color: 'red', style: 'solid' },
    { label: 'Response', color: 'green', style: 'solid' },
    { label: 'Snoop', color: 'purple', style: 'solid' },
  ],`,
        'messages': `messages: [
    { path: 'Source->Target', label: 'Message', color: 'red', style: 'solid', fromTime: 0, toTime: 1 },
  ],`,
        'lanes': `lanes: ['Source', 'Target'],`,
        'states': `states: [
    { lane: 'Source', label: 'State', color: 'yellow', fromTime: 0, toTime: 0.5 },
  ],`,
        'infoboxes': `infoBoxes: [
    { lane: 'Target', time: 2, text: 'Info text here' },
  ],`,
        'lanegroups': `laneGroups: [
    { label: 'Group Name', lanes: ['Source', 'Target'] },
  ],`,
        'title': `title: 'Your Diagram Title',`
      };
      
      const suggestions = [];
      for (const key in snippets) {
        if (key.startsWith(word)) {
          suggestions.push({
            text: snippets[key],
            displayText: key + " (snippet)"
          });
        }
      }
      
      if (suggestions.length === 0) return null;
      
      return {
        list: suggestions,
        from: CodeMirror.Pos(cur.line, start),
        to: CodeMirror.Pos(cur.line, end)
      };
    });
  </script>
  
  <!-- CodeMirror initialization script -->
  <script>
    let codeMirrorEditor;
    
    document.addEventListener('DOMContentLoaded', () => {
      // Get the hidden textarea
      const textarea = document.getElementById('input');
      
      // Create CodeMirror editor with snippet autocomplete
      codeMirrorEditor = CodeMirror(document.getElementById('codemirror-container'), {
        value: textarea.value,
        mode: 'javascript',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 2,
        tabSize: 2,
        indentWithTabs: false,
        matchBrackets: true,
        autoCloseBrackets: true,
        lineWrapping: true,
        extraKeys: {
          "Tab": function(cm) {
            // If autocomplete is active, accept the completion
            if (cm.state.completionActive && cm.state.completionActive.widget) {
              cm.state.completionActive.widget.pick();
            } else {
              // Otherwise, handle normal tab behavior
              if (cm.somethingSelected()) {
                cm.indentSelection("add");
              } else {
                cm.replaceSelection("  ", "end");
              }
            }
          }
        }
      });
      
      // Simple autocomplete on typing
      codeMirrorEditor.on("keyup", function(cm, event) {
        // Don't trigger if already active or on Enter
        if (!cm.state.completionActive && event.keyCode !== 13) {
          // Only trigger on letters
          if (/[a-zA-Z]/.test(String.fromCharCode(event.keyCode))) {
            CodeMirror.showHint(cm, CodeMirror.hint.snippets, {
              completeSingle: false,
              alignWithWord: true,
              closeCharacters: /[\s()\[\]{};:>,]/,
              closeOnUnfocus: true
            });
          }
        }
      });
      
      // Sync CodeMirror content with hidden textarea
      codeMirrorEditor.on('change', function() {
        textarea.value = codeMirrorEditor.getValue();
      });
      
      // Auto-render on page load
      renderGraph();
    });
    
    // Optional: Function to update CodeMirror content programmatically
    function updateCodeMirrorContent(content) {
      if (codeMirrorEditor) {
        codeMirrorEditor.setValue(content);
      }
    }
  </script>

  <!-- load your renderer -->
  <script src="src/js/main.js"></script>
</body>
</html>

